<!doctype html>

<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Batucada â€¢ Lecteur de morceaux (JSON + fichiers locaux)</title>
<meta name="theme-color" content="#111" />
<style>
  :root{
    --bg:#ffffff; --fg:#0b0b0b; --muted:#666; --card:#f7f7f8; --accent:#2563eb; --border:#e6e6e6;
  }
  @media (prefers-color-scheme: dark){
    :root{ --bg:#0c0c0f; --fg:#f5f7fb; --muted:#9aa0a6; --card:#15161a; --accent:#60a5fa; --border:#25262b; }
  }
  [data-theme="light"]{ --bg:#ffffff; --fg:#0b0b0b; --muted:#666; --card:#f7f7f8; --accent:#2563eb; --border:#e6e6e6; }
  [data-theme="dark"]{ --bg:#0c0c0f; --fg:#f5f7fb; --muted:#9aa0a6; --card:#15161a; --accent:#60a5fa; --border:#25262b; }*{box-sizing:border-box} html,body{margin:0; background:var(--bg); color:var(--fg); font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,sans-serif} .app{max-width:960px; margin:0 auto; padding:0 14px 80px} header{position:sticky; top:0; z-index:10; backdrop-filter:saturate(1.2) blur(6px); background:color-mix(in srgb, var(--bg) 85%, transparent); border-bottom:1px solid var(--border)} .bar{display:flex; align-items:center; gap:10px; padding:10px 6px} .iconbtn{appearance:none; border:1px solid var(--border); background:var(--card); color:var(--fg); border-radius:10px; padding:8px 10px; display:inline-flex; align-items:center; gap:8px; font-weight:600} .title{font-weight:800; letter-spacing:.2px; margin-left:4px} .spacer{flex:1} .pill{font-size:.85rem; color:var(--muted)} .note{font-size:.95rem; color:var(--muted); margin:6px 0 12px}

.controls{display:grid; grid-template-columns:1fr; gap:12px; padding:10px 0 6px} @media(min-width:680px){ .controls{ grid-template-columns: 1fr 1fr auto; align-items:end; } } .field{display:flex; flex-direction:column; gap:6px} label{font-size:.9rem; color:var(--muted)} input[type="file"], button, select{padding:10px 12px; border:1px solid var(--border); border-radius:10px; background:var(--card); color:var(--fg)} button.primary{background:var(--accent); color:white; border-color:transparent; font-weight:700}

.playerCard{margin:14px 0; padding:14px; border:1px solid var(--border); border-radius:14px; background:var(--card)} .playerCard h2{font-size:1rem; margin:0 0 8px} audio{width:100%}

.sections{display:grid; grid-template-columns:1fr; gap:12px; margin-top:14px} @media(min-width:700px){ .sections{ grid-template-columns: repeat(2, minmax(0,1fr)); } }

.part{border:1px solid var(--border); border-radius:14px; overflow:hidden; background:var(--card)} .part h3{font-size:1rem; margin:0; padding:10px 12px; border-bottom:1px solid var(--border)} .sheet{display:flex; align-items:center; justify-content:center; aspect-ratio:4/3; background: repeating-linear-gradient(0deg, #0000, #0000 10px, color-mix(in srgb, var(--border) 60%, transparent) 10px, color-mix(in srgb, var(--border) 60%, transparent) 11px); cursor:pointer;} .sheet .label{background:rgba(0,0,0,.08); color:var(--fg); padding:6px 10px; border-radius:20px; font-weight:700; backdrop-filter:blur(2px)} .meta{display:flex; gap:10px; align-items:center; padding:10px 12px; color:var(--muted); font-size:.9rem} .dot{width:7px; height:7px; border-radius:50%; background:var(--accent)}

.sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0} .jsonPreview{white-space:pre-wrap; font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:.9rem; color:var(--muted)} </style>

</head>
<body>
<div class="app" id="app" data-theme="">
  <header>
    <div class="bar">
      <div class="title">Batucada</div>
      <span class="pill" id="songName">(aucun morceau chargÃ©)</span>
      <div class="spacer"></div>
      <button class="iconbtn" id="themeBtn" title="Basculer clair/sombre">ðŸŒ“ ThÃ¨me</button>
    </div>
  </header>  <main>
    <section class="controls" aria-labelledby="loaders">
      <h2 id="loaders" class="sr-only">Chargement des fichiers</h2>
      <div class="field">
        <label for="jsonFile">1) Charger le fichier JSON du morceau</label>
        <input id="jsonFile" type="file" accept="application/json" />
      </div>
      <div class="field">
        <label for="mediaFiles">2) Charger les mÃ©dias (audio + images) â€” fichiers locaux</label>
        <input id="mediaFiles" type="file" accept="audio/*,image/*" multiple />
      </div>
      <div class="field">
        <label>&nbsp;</label>
        <button id="resetBtn" class="iconbtn">RÃ©initialiser</button>
      </div>
      <div class="field" style="grid-column:1/-1">
        <details>
          <summary>Voir / copier le schÃ©ma JSON (exemple)</summary>
          <pre class="jsonPreview" id="schemaBox"></pre>
        </details>
      </div>
    </section><section class="playerCard" aria-labelledby="fullTrackTitle" hidden>
  <h2 id="fullTrackTitle">Ã‰coutez le morceau en entier</h2>
  <audio id="player" controls preload="metadata">
    <source id="audioSrc" src="" />
    Votre navigateur ne supporte pas la balise audio.
  </audio>
</section>

<section aria-labelledby="partsTitle" hidden>
  <h2 id="partsTitle" class="sr-only">Sections (partitions)</h2>
  <div id="sections" class="sections"></div>
</section>

  </main>
</div><script>
/* ------------------ JSON SCHÃ‰MA D'EXEMPLE ------------------ */
const JSON_EXAMPLE = {
  "$schema": "https://example.com/batucada.schema.v1.json",
  "title": "Bonobo",
  "credits": { "composer": "Nom du prof", "notes": "Usage interne au groupe" },
  "audio": "bonobo.mp3", // peut Ãªtre aussi une URL http(s)
  "cover": "bonobo-cover.jpg", // optionnel
  "parts": [
    { "id": "intro", "label": "Intro", "start": 0,     "end": 12.3,  "images": ["intro-1.jpg"], "text": "EntrÃ©e des surdos" },
    { "id": "p1",    "label": "PremiÃ¨re partie", "start": 12.3,  "end": 36.5,  "images": ["p1.jpg"],      "text": "Motif principal" },
    { "id": "p2",    "label": "DeuxiÃ¨me partie",  "start": 36.5,  "end": 64.0,  "images": ["p2a.jpg","p2b.jpg"], "text": "Variation" },
    { "id": "finale","label": "Final",            "start": 64.0,  "end": null,  "images": ["finale.jpg"],  "text": "Sortie" }
  ]
};

/* ------------------ OUTILS ------------------ */
const el = (s, r=document) => r.querySelector(s);
const els = (s, r=document) => Array.from(r.querySelectorAll(s));

const app = el('#app');
const jsonInput = el('#jsonFile');
const mediaInput = el('#mediaFiles');
const resetBtn = el('#resetBtn');
const schemaBox = el('#schemaBox');

const playerCard = el('.playerCard');
const partsSection = el('[aria-labelledby="partsTitle"]');
const player = el('#player');
const audioSrc = el('#audioSrc');
const sectionsWrap = el('#sections');
const songName = el('#songName');

// Map des fichiers mÃ©dias locaux par nom => objectURL
let mediaMap = new Map();
let currentSong = null;
let loopRAF = null;

function setTheme(mode){ app.setAttribute('data-theme', mode); localStorage.setItem('bat_theme', mode); }
function initTheme(){ setTheme(localStorage.getItem('bat_theme') || ""); }

function isHttpUrl(str){ try{ const u = new URL(str); return u.protocol === 'http:' || u.protocol === 'https:'; }catch{ return false; } }
function resolveMediaRef(ref){
  if (!ref) return '';
  if (isHttpUrl(ref)) return ref;
  // chercher par nom de fichier dans la map
  if (mediaMap.has(ref)) return mediaMap.get(ref);
  // essayer de normaliser juste le nom sans dossier
  const name = ref.split(/[\\\/]/).pop();
  for (const [k,v] of mediaMap.entries()){
    if (k.split(/[\\\/]/).pop() === name) return v;
  }
  return ref; // fallback brut (au cas oÃ¹ le fichier est accessible par URL relative)
}

function clearLoop(){ if (loopRAF) cancelAnimationFrame(loopRAF); loopRAF = null; player.loop = false; }

function playSegment(start, end){
  clearLoop();
  try{ player.pause(); }catch{}
  player.currentTime = Math.max(0, Number(start)||0);
  player.play().catch(()=>{});
  if (isFinite(end)){
    const s = Math.max(0, Number(start)||0);
    const e = Math.max(s+0.25, Number(end));
    const tick = ()=>{ if (player.currentTime >= e) player.currentTime = s; loopRAF = requestAnimationFrame(tick); };
    loopRAF = requestAnimationFrame(tick);
  }
}

function renderSong(song){
  currentSong = song;
  songName.textContent = song.title || '(sans titre)';
  // audio
  const resolvedAudio = resolveMediaRef(song.audio);
  audioSrc.src = resolvedAudio || '';
  player.pause(); player.load();
  playerCard.hidden = !resolvedAudio;

  // parts
  sectionsWrap.innerHTML = '';
  (song.parts||[]).forEach((p, idx)=>{
    const art = document.createElement('article');
    art.className = 'part';
    const imgs = Array.isArray(p.images)? p.images : (p.image? [p.image] : []);
    const firstImg = imgs[0] ? resolveMediaRef(imgs[0]) : null;
    art.innerHTML = `
      <h3>${p.label || `Partie ${idx+1}`}</h3>
      <figure class="sheet" role="button" tabindex="0" aria-label="Lire ${p.label || `Partie ${idx+1}`}">
        <span class="label">${p.text ? p.text.replace(/</g,'&lt;') : (p.label||'Partie')}</span>
      </figure>
      <div class="meta"><span class="dot"></span> RepÃ¨re : ${isFinite(p.start)? Number(p.start).toFixed(1) : 'â€”'} s${isFinite(p.end)? ` â€¢ fin : ${Number(p.end).toFixed(1)} s` : ''}</div>
    `;
    const fig = el('.sheet', art);
    if (firstImg){
      fig.style.background = `center/cover no-repeat url("${firstImg}")`;
      fig.querySelector('.label').style.background = 'rgba(0,0,0,.35)';
      fig.querySelector('.label').style.color = '#fff';
    }
    fig.addEventListener('click', ()=> playSegment(p.start, p.end));
    fig.addEventListener('keydown', (e)=>{ if (e.key==='Enter' || e.key===' ') { e.preventDefault(); playSegment(p.start, p.end); }});
    sectionsWrap.appendChild(art);
  });
  partsSection.hidden = !(song.parts && song.parts.length);
}

async function handleJsonFile(file){
  const txt = await file.text();
  let data = null;
  try{ data = JSON.parse(txt); }
  catch(e){ alert('JSON invalide'); return; }
  renderSong(data);
}

function handleMediaFiles(fileList){
  // nettoyer anciens URLs
  for (const url of mediaMap.values()) URL.revokeObjectURL(url);
  mediaMap.clear();
  Array.from(fileList).forEach(f=>{
    const url = URL.createObjectURL(f);
    mediaMap.set(f.name, url);
  });
  // re-rÃ©soudre les mÃ©dias si un morceau est dÃ©jÃ  chargÃ©
  if (currentSong) renderSong(currentSong);
}

function resetAll(){
  clearLoop();
  mediaMap.forEach(url => URL.revokeObjectURL(url));
  mediaMap.clear();
  currentSong = null;
  songName.textContent = '(aucun morceau chargÃ©)';
  audioSrc.src = '';
  player.pause(); player.load();
  playerCard.hidden = true; partsSection.hidden = true; sectionsWrap.innerHTML = '';
  jsonInput.value = ''; mediaInput.value = '';
}

// initialiser schÃ©ma affichÃ©
schemaBox.textContent = JSON.stringify(JSON_EXAMPLE, null, 2)
  .replace(/\"/g,'"');

// Ã©vÃ©nements
initTheme();

document.getElementById('themeBtn').addEventListener('click', ()=>{
  const cur = app.getAttribute('data-theme') || "";
  if (cur === 'dark') setTheme('light');
  else if (cur === 'light') setTheme('');
  else setTheme('dark');
});

jsonInput.addEventListener('change', (e)=>{ const f = e.target.files?.[0]; if (f) handleJsonFile(f); });
mediaInput.addEventListener('change', (e)=> handleMediaFiles(e.target.files||[]));
resetBtn.addEventListener('click', resetAll);

// Stopper la boucle si lâ€™utilisateur lance/seek le morceau complet
const stopLoop = ()=> clearLoop();
['play','seeking','ended'].forEach(ev=> player.addEventListener(ev, stopLoop));
</script></body>
</html>